---
title: "How to use shapper for classification"
author: "Alicja Gosiewska"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
vignette: >
  %\VignetteEngine{knitr::knitr}
  %\VignetteIndexEntry{How to use shapper for classification}
  %\usepackage[UTF-8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      eval = FALSE)
```

# Introduction

The `shapper` is an R package which ports the `shap` python library in R. For details and examples see [shapper repository on github](https://github.com/ModelOriented/shapper) and [shapper website](https://modeloriented.github.io/shapper/).

SHAP (SHapley Additive exPlanations) is a method to explain predictions of any machine learning model. 
For more details about this method see [shap repository on github](https://github.com/slundberg/shap).

## Python library shap

To run shapper python library shap is required. It can be installed both by python or R. To install it throught R, you an use function `install_shap` from the `shapper` package.

```{r, eval = FALSE}
shapper::install_shap()
```


# Load data sets

The example usage is presented on the `HR` dataset from the R package `DALEX`. For more details see [DALEX2 github repository](https://github.com/ModelOriented/DALEX2).

```{r}
library("DALEX")
Y_train <- HR$status
x_train <- HR[ , -6]

```

# Let's build models

```{r}
library("randomForest")
set.seed(123)
model_rf <- randomForest(x = x_train, y = Y_train)

library(rpart)
model_tree <- rpart(status~. , data = HR)
```

# Here shapper starts

First step is to create an explainer for each model. The explainer is an object that wraps up a model and meta-data.
```{r}
library(shapper)

p_function <- function(model, data) predict(model, newdata = data, type = "prob")

ive_rf <- individual_variable_effect(model_rf, data = x_train, predict_function = p_function,
            new_observation = x_train[1:2,], nsamples = 50)


ive_tree <- individual_variable_effect(model_tree, data = x_train, predict_function = p_function,
            new_observation = x_train[1:2,], nsamples = 50)

```

```{r}
ive_rf
```
```
    gender      age    hours evaluation salary _id_ _ylevel_ _yhat_ _yhat_mean_    _vname_ _attribution_ _sign_      _label_
1     male 32.58267 41.88626          3      1    1    fired  0.854   0.3755216     gender   -0.03312199      - randomForest
1.3   male 32.58267 41.88626          3      1    1    fired  0.854   0.3755216        age    0.02135603      + randomForest
1.4   male 32.58267 41.88626          3      1    1    fired  0.854   0.3755216      hours    0.30846492      + randomForest
1.5   male 32.58267 41.88626          3      1    1    fired  0.854   0.3755216 evaluation    0.11945970      + randomForest
1.6   male 32.58267 41.88626          3      1    1    fired  0.854   0.3755216     salary    0.06231975      + randomForest
1.1   male 32.58267 41.88626          3      1    1       ok  0.144   0.2758111     gender    0.02735491      + randomForest
```

# Plotting results

```{r plot1}
plot(ive_rf)
```

![](https://raw.githubusercontent.com/ModelOriented/shapper/master/materials/vignettes_plots/classification_plot1.png)

To see only attributions use option `show_predcited = FALSE`.

```{r}
plot(ive_rf, show_predcited = FALSE)
```

![](https://raw.githubusercontent.com/ModelOriented/shapper/master/materials/vignettes_plots/classification_plot2.png)

We can show many models on one grid.

```{r}
plot(ive_rf, ive_tree, show_predcited = FALSE)
```


![](https://raw.githubusercontent.com/ModelOriented/shapper/master/materials/vignettes_plots/classification_plot3.png)

## Let's filter data for plot


```{r}
ive_rf_filtered <- ive_rf[ive_rf$`_ylevel_` =="fired", ]
shapper:::plot.individual_variable_effect(ive_rf_filtered)
```


![](https://raw.githubusercontent.com/ModelOriented/shapper/master/materials/vignettes_plots/classification_plot4.png)
